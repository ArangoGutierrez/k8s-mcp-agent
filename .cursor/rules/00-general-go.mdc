---
description: General Go development standards for k8s-mcp-agent
globs:
  - "**/*.go"
---

# Go Development Standards

## Style & Conventions
- Follow **Effective Go** principles
- Use `gofmt -s` (simplify) for all code
- Run `go vet` before commits
- Use `golangci-lint` if configured in repo
- Documentation comments limited to 80 characters; wrap if needed
- Public packages (non-`internal/`) must have comprehensive godoc

## Error Handling
- **ALWAYS** wrap errors with context: `fmt.Errorf("operation failed: %w", err)`
- Use `%w` verb for error wrapping to preserve error chains
- **NO PANIC** in production code (exceptions: `main` init failures only)
- Return errors explicitly; avoid silent failures
- Check all error returns immediately

## Concurrency
- Pass `context.Context` as **first parameter** in all functions that:
  - Perform I/O operations
  - Make external calls (NVML, K8s API)
  - May need cancellation/timeout
- Use `context.WithTimeout` for operations with deadlines
- Respect context cancellation: `select { case <-ctx.Done(): return ctx.Err() }`

## Testing
- **Table-driven tests** for all core logic
- Use `testify/assert` for assertions (preferred over raw `if` checks)
- Test file naming: `*_test.go` in same package
- Coverage target: >70% for `pkg/`, >50% for `cmd/`
- Mock external dependencies (NVML, K8s client) using interfaces
- Run tests with: `go test ./... -count=1 -race`

## Package Structure
- `cmd/`: Main applications, minimal logic
- `pkg/`: Public, reusable libraries
- `internal/`: Private implementation details
- Keep `main()` functions clean: setup, run, shutdown

## Dependencies
- Prefer standard library over third-party packages
- Justify each new dependency in PR description
- Use `go mod tidy` before commits
- Pin versions for stability

## Performance
- Profile before optimizing (`pprof`)
- Prefer simplicity over premature optimization
- Document performance-critical sections
- Use pooling (`sync.Pool`) for high-frequency allocations
