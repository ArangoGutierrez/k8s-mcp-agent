---
description: Workflow authorization protocol and Git standards
globs:
  - "**/*"
---

# Workflow & Git Protocol Standards

## Scratchpad Convention
- **ALWAYS maintain** a `scratchpad.md` file in `/tmp/` or project root
- Purpose: Model notepad for tracking progress, decisions, and state
- **NOT** for user consumption - internal agent memory
- Update after each completed task

## Authorization Protocol

### Before ANY Task
```
1. Present plan with steps
2. WAIT for "GO" confirmation
3. Execute ONE step
4. Report results
5. WAIT for next "GO"
```

### Phase Execution Pattern
```
Epic (Milestone)
├── Task 1 → Plan → GO → Execute → Commit → Update scratchpad
├── Task 2 → Plan → GO → Execute → Commit → Update scratchpad
└── Task N → ...
```

### NEVER Do This
- Chain operations without approval
- Assume next steps
- Skip verification checkpoints
- Push directly to main/master

## Git Protocol

### Branch Types
Use semantic prefixes for all branches:
```
feat/       - New features
fix/        - Bug fixes
chore/      - Maintenance tasks
docs/       - Documentation only
refactor/   - Code refactoring
infra/      - Infrastructure/tooling
security/   - Security patches
```

### Commit Format (REQUIRED)
```bash
git commit -s -S -m "type(scope): description"
```

**Flags (BOTH REQUIRED):**
- `-s` → Signed-off-by (Developer Certificate of Origin)
- `-S` → GPG signature
- **NO commits without both flags**

**Type:**
- `feat`, `fix`, `chore`, `docs`, `refactor`, `infra`, `security`

**Scope:**
- Component affected: `mcp`, `nvml`, `k8s`, `ci`, `init`, etc.

**Examples:**
```bash
git commit -s -S -m "feat(mcp): implement stdio transport"
git commit -s -S -m "fix(nvml): handle missing GPU gracefully"
git commit -s -S -m "chore(deps): update go-nvml to v0.12.0"
```

### Pull Request Requirements

#### BEFORE PR Creation
```bash
make test           # Run full test suite
go fmt ./...        # Format code
go vet ./...        # Lint code
```

#### PR MUST Have
1. **Linked Issue:** Use "Fixes #XX" or "Closes #XX" in body
2. **Label:** At least one (kind/, area/, prio/)
3. **Milestone:** Assign to M1, M2, M3, or M4

#### BEFORE Merge
```bash
gh pr checks <PR#> --watch    # Wait for CI to pass
# Review Copilot/bot comments
# Address all review feedback
```

### Workflow Quick Reference
```bash
# 1. Create issue
gh issue create --title "..." --label "kind/feature" --milestone "M1"

# 2. Create branch
git checkout -b feat/description

# 3. Work and test
# ... make changes ...
make test

# 4. Commit (DCO + GPG)
git commit -s -S -m "feat(scope): description"

# 5. Push
git push origin feat/description

# 6. Create PR
gh pr create --title "..." --body "Fixes #XX" --label "kind/feature" --milestone "M1"

# 7. Wait for checks
gh pr checks <PR#> --watch

# 8. Merge (after approval)
gh pr merge <PR#> --merge --delete-branch
```

### Branch Protection
- **main branch:** Protected, requires PR + reviews
- **feature branches:** Can force-push before PR creation
- **After PR creation:** No force-push (breaks review context)

### Commit Message Guidelines
- **Subject line:** ≤72 characters
- **Body:** Wrap at 80 characters
- **Include:** Why the change was made, not just what changed
- **Reference:** Related issues, RFCs, or discussions

### DCO Sign-off
All commits MUST include Developer Certificate of Origin:
```
Signed-off-by: Your Name <your.email@example.com>
```
Automatically added by `git commit -s`

### GPG Signing
All commits MUST be GPG signed for verification:
```
git config --global commit.gpgsign true
git config --global user.signingkey <YOUR_KEY_ID>
```

## Testing Standards

### Pre-commit Checklist
- [ ] `go fmt ./...` - Code formatted
- [ ] `go vet ./...` - No vet warnings
- [ ] `golangci-lint run` - Linter passes (if configured)
- [ ] `go test ./... -count=1` - All tests pass
- [ ] `go test ./... -race` - No race conditions
- [ ] Documentation updated if needed

### CI/CD Expectations
- All PRs must pass GitHub Actions checks
- Test coverage should not decrease
- Linter warnings treated as errors in CI
- Build must succeed for all target architectures
