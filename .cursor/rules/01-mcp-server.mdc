---
description: MCP Protocol and transport layer standards
globs:
  - "**/{server,mcp}/**"
---

# MCP Server Development Standards

## Library & Protocol
- **Library:** Use `github.com/mark3labs/mcp-go` exclusively
- **Protocol:** JSON-RPC 2.0 over configurable transport
- **Primary transport:** HTTP/SSE (MCP Streamable HTTP)
- **Legacy transport:** Stdio (for debugging/direct kubectl exec)

## Transport Modes

### HTTP Mode (Production Default)
- Agent runs as persistent HTTP server on port 8080
- Used by gateway for pod-to-pod HTTP routing
- Low memory footprint (~15-20MB resident)
- NVML initialized once at startup
- Endpoints:
  - `/mcp` - MCP Streamable HTTP transport
  - `/healthz` - Liveness probe
  - `/readyz` - Readiness probe
  - `/metrics` - Prometheus metrics

### Stdio Mode (Debug/Legacy)
- For direct `kubectl exec` access
- Oneshot mode for single tool calls
- Higher per-request overhead (process spawn + NVML init)
- Useful for SRE debugging without gateway

## I/O Separation (Stdio Mode Only)
- **stdout:** MCP protocol ONLY (JSON-RPC messages)
- **stderr:** Structured logging, debug output, diagnostics
- **NEVER** write logs/debug to stdout - breaks protocol parsing
- **NEVER** read from stdin except for MCP messages

## Logging
- Use structured JSON logging to `stderr` only
- Format: `{"level":"info","msg":"...", "component":"mcp-server"}`
- Log levels: `debug`, `info`, `warn`, `error`, `fatal`
- Include timestamps (ISO 8601) and request IDs when available

## Tool Implementation
- Each tool returns `application/json` string for complex data
- Validate all inputs before processing
- Return errors as JSON, not Go error strings
- Include helpful context in error messages

## Schema Definition
- Define tool schemas explicitly in server registration
- Document parameter types, constraints, and examples
- Mark required vs optional parameters clearly
- Provide default values where sensible

## Server Lifecycle

### HTTP Mode
1. **Init:** Parse flags, setup logging (stderr), init NVML
2. **Run:** Start HTTP server, block on context
3. **Shutdown:** Graceful HTTP shutdown, cleanup NVML, exit 0

### Stdio Mode
1. **Init:** Parse flags, setup logging (stderr), init NVML
2. **Run:** Start MCP stdio server, block on transport
3. **Shutdown:** Cleanup NVML, flush logs, exit 0

## Error Handling
- Catch panics in tool handlers (recover to JSON error)
- Distinguish between:
  - **Protocol errors** (malformed JSON-RPC)
  - **Application errors** (tool execution failures)
  - **System errors** (hardware unavailable)
- Return appropriate JSON-RPC error codes

## Testing
- Mock stdio transport for unit tests
- Test JSON-RPC message parsing separately
- Validate tool schemas programmatically
- Integration tests: full stdio round-trip
- HTTP tests: endpoint validation

## Security
- Sanitize all tool inputs (PIDs, counts, paths)
- No shell execution from tool parameters
- Validate numeric ranges (e.g., GPU index bounds)
- Reject unexpected parameters
