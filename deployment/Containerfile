# Copyright 2026 k8s-gpu-mcp-server contributors
# SPDX-License-Identifier: Apache-2.0

# Multi-stage Dockerfile for k8s-gpu-mcp-server
# Produces a minimal, secure container for ephemeral GPU diagnostics

# =============================================================================
# Stage 1: Builder
# =============================================================================
FROM golang:1.25-bookworm AS builder

# Install build dependencies for CGO (NVML bindings)
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libc6-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Download dependencies first (better layer caching)
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build arguments for version injection
ARG VERSION=dev
ARG GIT_COMMIT=unknown

# Build the agent binary with CGO enabled for NVML
# Using dynamic linking - libnvidia-ml.so provided at runtime by nvidia-container-toolkit
RUN CGO_ENABLED=1 GOOS=linux go build \
    -ldflags="-s -w \
        -X github.com/ArangoGutierrez/k8s-gpu-mcp-server/internal/info.version=${VERSION} \
        -X github.com/ArangoGutierrez/k8s-gpu-mcp-server/internal/info.gitCommit=${GIT_COMMIT}" \
    -o /agent \
    ./cmd/agent

# Verify the binary works (basic sanity check)
RUN /agent --version

# =============================================================================
# Stage 2: Runtime (Distroless + Busybox)
# =============================================================================
FROM busybox:1.37-musl AS busybox

FROM gcr.io/distroless/base-debian12:nonroot

# OCI Image Labels
LABEL org.opencontainers.image.title="k8s-gpu-mcp-server"
LABEL org.opencontainers.image.description="Ephemeral GPU diagnostic agent for Kubernetes via MCP"
LABEL org.opencontainers.image.source="https://github.com/ArangoGutierrez/k8s-gpu-mcp-server"
LABEL org.opencontainers.image.licenses="Apache-2.0"
LABEL org.opencontainers.image.vendor="ArangoGutierrez"

# Copy the agent binary from builder
COPY --from=builder /agent /agent

# Copy busybox for sleep capability (DaemonSet idle pattern)
# Adds ~1.2MB but enables `sleep infinity` for K8s deployments
COPY --from=busybox /bin/busybox /bin/busybox
COPY --from=busybox /bin/sh /bin/sh
COPY --from=busybox /bin/sleep /bin/sleep

# NVML requires libnvidia-ml.so from the host
# This is automatically mounted by nvidia-container-toolkit when using:
#   docker run --gpus all ...
#   or kubectl with runtimeClassName: nvidia

# Note: USER is not set - let K8s securityContext control it
# NVML may require root (runAsUser: 0) in DaemonSet deployments

# Expose no ports - stdio transport only (MCP over stdin/stdout)

# Default entrypoint and arguments
ENTRYPOINT ["/agent"]
CMD ["--nvml-mode=real", "--mode=read-only"]
